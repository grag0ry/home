#!/bin/bash

set -e -u -o pipefail

readonly USAGE="usage: $0 [-tlxw]"
TUI=a; GUI=a; WSL=a; LEM=a; ASK=
while getopts "tTlLxXwWynh" o; do case "$o" in
    t) TUI=1 ;; T) TUI=  ;;
    l) LEM=1 ;; L) LEM=  ;;
    x) GUI=1 ;; X) GUI=  ;;
    w) WSL=1 ;; W) WSL=  ;;
    y) ASK=y ;; n) ASK=n ;;
    h) printf "%s\n" "$USAGE" \
                     "  -t/-T    force enable/disable TUI" \
                     "  -l/-L    force enable/disable lemonade open" \
                     "  -x/-X    force enable/disable GUI" \
                     "  -w/-W    force enable/disable WSL" \
                     "  -y/-n    force answer yes/no" \
        ; return 0 ;;
    ?) echo "$USAGE"; return 1 ;;
esac; done; shift $((OPTIND - 1));
[[ $TUI = a ]] && { [[ -t 0 ]] && TUI=1 || TUI= ;}
[[ -n ${SSH_TTY:-} ]] && SSH=1 || SSH=
[[ $GUI = a ]] && { [[ -n ${DISPLAY:-} ]] || GUI= ;}
[[ $WSL = a ]] && { [[ -n ${WSL_INTEROP:-} ]] || WSL= ;}
[[ $LEM = a ]] && { [[ -n $SSH ]] && LEM=1 || LEM= ;}

readonly TUI GUI WSL LEM SSH ASK
readonly WSL_PS="/mnt/c/Windows/System32/WindowsPowerShell/v1.0/powershell.exe"

yesno() {
    [[ $ASK = y ]] && return 0
    [[ $ASK = n ]] && return 1
    [[ -n $TUI ]] || return 1
    local ans
    read -r -p "$1 (y/n): " ans
    case "${ans@L}" in
        y|ye|yes) return 0 ;;
        *) return 1 ;;
    esac
}

xopen-fallback-wsl() {
    if [[ $WSL = a && -n $SSH ]]; then
        yesno "wslopen '$1'?" || return 101
    fi
    setsid -f wslopen "$1" >/dev/null 2>&1 </dev/null
    exit 0
}

xopen-fallback-gui() {
    if [[ $GUI = a && -n $SSH ]]; then
        yesno "xdg-open '$1'?" || return 101
    fi
    setsid -f xdg-open "$1" >/dev/null 2>&1 </dev/null
    exit 0
}

xopen-fallback() {
    [[ -n $WSL ]] && xopen-fallback-wsl "$1"
    [[ -n $GUI ]] && xopen-fallback-gui "$1"
    exit 102
}

FILE=${1?$USAGE}

if [[ $FILE =~ ^[a-zA-Z][a-zA-Z0-9+.-]*: ]]; then
    if [[ ${BASH_REMATCH[0]} = file: && $FILE = file://* ]]; then
        FILE=${FILE/#file:\/\//}
    else
        # Url processing
        [[ -n $LEM ]] && exec timeout 2s lemonade open "$FILE"
        xopen-fallback "$FILE"
    fi
fi

[[ -n $TUI ]] || xopen-fallback "$FILE"

if [[ -d $FILE ]]; then
    exec nnn "$FILE"
fi

EXT=${FILE##*.}
EXT=${EXT@L}

EXE=
if [[ -n $WSL ]]; then
    case "$EXT" in
        exe) EXE=exe ;;
        bat) EXE=bat ;;
        ps1) EXE=ps1 ;;
    esac
fi
if [[ -x $FILE ]]; then
    case "$(head -c4 "$FILE")" in
        $'\x7FELF') EXE=elf ;;
        '#!'*)      EXE=shebang ;;
    esac
fi

if [[ -n $EXE ]]; then
    ACTIONS=(exec setsid)
    [[ -n $WSL ]] && ACTIONS+=(wincmd)
    [[ -n $GUI ]] && ACTIONS+=(kitty)
    case "$EXE" in
        elf)
            ACTIONS+=(objdump-f)
            CMD=("$FILE")
            WINCMD="wsl -d ${WSL_DISTRO_NAME} bash -lic ${FILE@Q}"
        ;;
        shebang)
            ACTIONS+=(edit)
            CMD=("$FILE")
            WINCMD="wsl -d ${WSL_DISTRO_NAME} bash -lic ${FILE@Q}"
        ;;
        exe)
            ACTIONS+=(objdump-f)
            CMD=("$FILE")
            WINCMD=$(wslpath -w "$FILE")
        ;;
        ps1)
            ACTIONS+=(edit)
            CMD=("$WSL_PS" -ExecutionPolicy Bypass "$(wslpath -w "$FILE")")
            WINCMD=$(wslpath -w "$FILE")
        ;;
        bat)
            ACTIONS+=(edit)
            DIR=$(dirname "$FILE")
            [[ $(stat -c %T -f "${DIR:-}") = v9fs ]] \
                && DIR="'$(wslpath -w "$DIR")'" \
                || DIR="\$env:USERPROFILE"
            CMD=("$WSL_PS" -ExecutionPolicy Bypass -Command "cd $DIR; & '$(wslpath -w "$FILE")'")
            WINCMD="cd $DIR; $(wslpath -w "$FILE")"
        ;;
    esac
    ACTIONS+=(cancel)
    select action in "${ACTIONS[@]}"; do case "$action" in
        exec)
            exec "${CMD[@]}"
        ;;
        setsid)
            setsid -f "${CMD[@]}" >/dev/null 2>&1 </dev/null
            exit 0
        ;;
        wincmd)
            setsid -f "$WSL_PS" \
                -NoProfile -NoLogo \
                -ExecutionPolicy Bypass \
                -WindowStyle Hidden \
                -Command "Start-Process powershell.exe -ArgumentList \"-NoExit\",\"-Command\",\"$WINCMD\"" \
                >/dev/null 2>&1 </dev/null
            exit 0
        ;;
        kitty)
            setsid -f kitty --hold -- "${CMD[@]}" >/dev/null 2>&1 </dev/null
            exit 0
        ;;
        edit)
            exec "$EDITOR" "$FILE"
        ;;
        objdump-f)
            objdump -f "$FILE" | "$PAGER"
            exit 0
        ;;
        cancel) exit 0 ;;
        *) echo >&2 "Invalid choice" ;;
    esac; done
fi

case "$(file --mime-type -b "$FILE")" in
    inode/directory)
        exec nnn "$FILE"
    ;;
    text/troff)
        exec man "$FILE"
    ;;
    text/*)
        exec "$EDITOR" "$FILE"
    ;;
    application/*-executable)
        objdump -f "$FILE" | "$PAGER"
        exit 0
    ;;
esac

xopen-fallback "$FILE"
