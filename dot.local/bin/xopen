#!/bin/bash

set -e -u -o pipefail

ASK=; FRC=;
readonly USAGE="usage: $0 [-tlxwa] [-f tui|wsl|gui|lem] file|url"
while getopts "tTlLxXwWahif:" o; do case "$o" in
    t) TUI=1 ;; T) TUI=  ;;
    l) LEM=1 ;; L) LEM=  ;;
    x) GUI=1 ;; X) GUI=  ;;
    w) WSL=1 ;; W) WSL=  ;;
    a) ASK=1 ;; f) FRC=$OPTARG ;;
    h) printf "%s\n" "$USAGE" \
                     "  -t/-T    force enable/disable TUI" \
                     "  -l/-L    force enable/disable lemonade open" \
                     "  -x/-X    force enable/disable GUI" \
                     "  -w/-W    force enable/disable WSL" \
                     "  -a       ask user" \
                     "  -f       force specific opener" \
        ; return 0 ;;
    ?) echo >&2 "$USAGE"; exit 1 ;;
esac; done; shift $((OPTIND - 1));
(( $# > 0 )) || { echo >&2 "$USAGE"; exit 1; }
[[ -n ${TUI+d} ]] || { [[ -t 0 ]] && TUI=1 || TUI= ;}
[[ -n ${GUI+d} ]] || { [[ -n ${DISPLAY:-} ]] && GUI=1 || GUI= ;}
[[ -n ${WSL+d} ]] || { [[ -n ${WSL_INTEROP:-} ]] && WSL=1 || WSL= ;}
[[ -n ${SSH_TTY:-} ]] && SSH=1 || SSH=
[[ -n ${LEM+d} ]] || { [[ -n $SSH ]] && LEM=1 || LEM= ;}

if [[ -n $ASK && -z $TUI ]]; then
    printf "%s\n" "$0: cannot ask user without tui" >&2
    exit 1
fi
if [[ -n $ASK && -n $FRC ]]; then
    printf "%s\n" "$0: cannot ask user and use force option" >&2
    exit 1
fi

xopen() {
    local file=$1; shift
    if [[ $file =~ ^[a-zA-Z][a-zA-Z0-9+.-]*:(//)? ]]; then
        if [[ ${BASH_REMATCH[0]} = file:// ]]; then
            file=${file/#file:\/\//}
        else
            xopen-url "${BASH_REMATCH[0]}" "$file"
        fi
    fi
    local ext=${file##*.}
    local exe=
    if [[ -n $WSL ]]; then
        case "$ext" in
            exe) exe=exe ;;
            bat) exe=bat ;;
            ps1) exe=ps1 ;;
        esac
    fi
    if [[ -x $file && -f $file ]]; then
        local magic
        read -r -N4 magic <"$file" || :
        case "$magic" in
            $'\x7FELF') exe=elf ;;
            '#!'*)      exe=shebang ;;
        esac
    fi
    [[ -n $exe ]] && xopen-run "$exe" "$file" "$@"
    xopen-file "$ext" "$file"
}

xopen-url() {
    [[ -n $FRC ]] && xopen-frc "$@"
    [[ -n $ASK ]] && TUI="" xopen-ask "$@"
    [[ -n $LEM ]] && xopen-lem "$@"
    [[ -n $WSL ]] && xopen-wsl "$@"
    [[ -n $GUI ]] && xopen-gui "$@"
    exit 2
}

xopen-run() {
    [[ -n $TUI ]] || exit 2
    local exe=$1
    local file=$2
    shift 2
    local opts=("run foreground" "nohup (run background)")
    [[ -n $WSL ]] && opts+=("wincmd (windows terminal)")
    [[ -n $GUI ]] && opts+=("kitty")
    local -a cmd=(); local wincmd=
    local -r ps="/mnt/c/Windows/System32/WindowsPowerShell/v1.0/powershell.exe"
    case "$exe" in
        elf)
            cmd=("$file" "$@")
            wincmd="wsl -d ${WSL_DISTRO_NAME} bash -lic ${file@Q} -- ${*@Q}"
        ;;
        shebang)
            cmd=("$file" "$@")
            wincmd="wsl -d ${WSL_DISTRO_NAME} bash -lic ${file@Q} -- ${*@Q}"
            opts+=("edit in \$EDITOR")
        ;;
        exe)
            cmd=("$file" "$@")
            wincmd="$(wslpath -w "$file") ${*@Q}"
        ;;
        ps1)
            cmd=("$ps" -ExecutionPolicy Bypass "$(wslpath -w "$file")" "$@")
            wincmd="$(wslpath -w "$file") ${*@Q}"
            opts+=("edit in \$EDITOR")
        ;;
        bat)
            local dir; dir=$(dirname "$file")
            [[ $(stat -c %T -f "${dir:-}") = v9fs ]] \
                && dir="'$(wslpath -w "$dir")'" \
                || dir="\$env:USERPROFILE"
            cmd=("$ps" -ExecutionPolicy Bypass -Command "cd $dir; & '$(wslpath -w "$file")' ${*@Q}")
            wincmd="cd $dir; $(wslpath -w "$file") ${*@Q}"
            opts+=("edit in \$EDITOR")
        ;;
    esac
    opts+=("cancel")
    local action=
    ask-user action "Run '$file' ${*@Q}" "${opts[@]}"
    case "$action" in
        run)
            exec "${cmd[@]}"
        ;;
        nohup)
            nohup "${cmd[@]}" >/dev/null 2>&1 &
            disown $!
            exit 0
        ;;
        wincmd)
            nohup "$ps" \
                -NoProfile -NoLogo \
                -ExecutionPolicy Bypass \
                -WindowStyle Hidden \
                -Command "Start-Process powershell.exe -ArgumentList \"-NoExit\",\"-Command\",\"$wincmd\"" \
                >/dev/null 2>&1 &
            disown $!
            exit 0
        ;;
        kitty)
            nohup kitty --hold -- "${cmd[@]}" >/dev/null 2>&1 &
            disown $!
            exit 0
        ;;
        edit)
            exec "$EDITOR" "$file"
        ;;
        cancel)
            exit 3
        ;;
    esac
    exit 2
}

xopen-file() {
    local LEM=
    [[ -n $FRC ]] && xopen-frc "$@"
    [[ -n $ASK ]] && xopen-ask "$@"
    [[ -n $TUI ]] && xopen-tui "$@"
    [[ -n $WSL ]] && xopen-wsl "$@"
    [[ -n $GUI ]] && xopen-gui "$@"
    exit 2
}

xopen-frc() {
    case "$FRC" in
        t|tui|term|terminal)       [[ -n $TUI ]] && xopen-tui "$@" ;;
        w|win|wsl|wslopen|windows) [[ -n $WSL ]] && xopen-wsl "$@" ;;
        x|gui|xdg-open)            [[ -n $GUI ]] && xopen-gui "$@" ;;
        l|lem|lemonade)            [[ -n $LEM ]] && xopen-lem "$@" ;;
        *)
            printf "%s\n" "$0: invalid force option" >&2
            exit 1
        ;;
    esac
    exit 2
}

xopen-ask() {
    local opts=(
        ${TUI:+"tui"}
        ${LEM:+"lem (lemonade open)"}
        ${GUI:+"gui (xdg-open)"}
        ${WSL:+"wsl (wslopen)"}
        cancel
    )
    (( ${#opts[@]} > 1 )) || exit 2
    local action=
    ask-user action "How to open '$2'" "${opts[@]}"
    case "$action" in
        tui) xopen-tui "$@" ;;
        lem) xopen-lem "$@" ;;
        wsl) xopen-wsl "$@" ;;
        gui) xopen-gui "$@" ;;
        cancel) exit 3 ;;
    esac
    exit 2
}

xopen-lem() { lemonade open "$2"; exit $!; }
xopen-wsl() { nohup wslopen "$2" >/dev/null 2>&1 & disown $!; exit 0; }
xopen-gui() { nohup xdg-open "$2" >/dev/null 2>&1 & disown $!; exit 0; }

xopen-tui() {
    local ext=$1
    local file=$2
    case "$(file --mime-type -b "$file")" in
        inode/directory)
            if [[ -n ${NNN_PIPE:-} ]]; then
                printf "%s\0" "0c$(realpath "$file")" > "$NNN_PIPE"
                exit 0
            else
                exec nnn "$file"
            fi
        ;;
        text/troff)
            exec man "$file"
        ;;
        text/*|application/json)
            exec "$EDITOR" "$file"
        ;;
    esac
    [[ -n $ASK || -n $SSH || -n $FRC ]] && TUI='' xopen-ask "$@"
    [[ -n $WSL ]] && xopen-wsl "$@"
    [[ -n $GUI ]] && xopen-gui "$@"
    exit 2
}

ask-user() {
    local -n opt=$1; local q=$2; shift 2
    printf "%s?\n" "$q"
    select opt in "$@"; do
        [[ -n $opt ]] && break || echo >&2 "Invalid choice"
    done
    opt=${opt%% *}
}

xopen "$@"
